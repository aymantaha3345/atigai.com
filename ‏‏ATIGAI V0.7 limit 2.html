<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATIGAI Image Generator</title>
    <style>

* {  
    margin: 0;  
    padding: 0;  
    box-sizing: border-box;  
}  
  
body {  
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;  
    background: linear-gradient(135deg, #1d1f21 0%, #2c3e50 100%);  
    color: #e5e5e5;  
    display: flex;  
    flex-direction: column;  
    align-items: center;  
    justify-content: flex-start;  
    height: 100vh;  
    margin: 0;  
    overflow: hidden;  
}  
  
.banner {  
    width: 100%;  
    height: 60px;  
    display: flex;  
    justify-content: space-between;  
    align-items: center;  
    padding: 0 20px;  
    background: linear-gradient(to right, #282c34, #373d48);  
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);  
    backdrop-filter: blur(10px);  
    -webkit-backdrop-filter: blur(10px);  
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);  
    position: relative;  
    z-index: 99999; /* نفس قيمة z-index للقائمة المنسدلة */  
}  
.banner-img {
  height: 40px;
  width: auto;
  transition: none;
  background: none !important; /* إزالة الخلفية */
  box-shadow: none !important; /* إزالة الظلال */
  filter: none !important; /* إزالة الفلاتر */
}

.banner-img:hover {
  transform: none;
  background: none !important;
  box-shadow: none !important;
  filter: none !important;
}

  
/* Dropdown Styles */  
.dropdown {  
    position: relative;  
    display: inline-block;  
    margin-left: auto;  
}  
  
.dropdown-toggle {  
    background: transparent;  
    border: none;  
    color: white;  
    cursor: pointer;  
    padding: 6px;  
    width: 35px;  
    height: 35px;  
    border-radius: 6px;  
    display: flex;  
    align-items: center;  
    justify-content: center;  
    transition: background-color 0.3s;  
    position: relative;  
    z-index: 99999;  
}  
.dropdown-toggle:hover {  
    background-color: rgba(255, 255, 255, 0.1);  
    transform: none;  
}  
  
.dropdown-toggle svg {  
    width: 20px;  
    height: 20px;  
}  
  
.dropdown-menu {  
    position: fixed;  
    top: 60px;  
    right: 20px;  
    background: rgba(40, 44, 52, 0.98);  
    backdrop-filter: blur(12px);  
    -webkit-backdrop-filter: blur(12px);  
    border: 1px solid rgba(255, 255, 255, 0.1);  
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);  
    border-radius: 8px;  
    padding: 8px 0;  
    min-width: 200px;  
    z-index: 99999;  
    display: none; /* إخفاء افتراضي */  
    animation: fadeIn 0.2s ease;  
    opacity: 0;  
    visibility: hidden;  
    transition: opacity 0.2s ease, visibility 0.2s ease;  
}  
  
/* عرض القائمة فقط عندما يكون العنصر الأب في حالة active */  
.dropdown.active .dropdown-menu {  
    display: block;  
    opacity: 1;  
    visibility: visible;  
}  
.dropdown-item {  
    display: flex;  
    align-items: center;  
    padding: 10px 16px;  
    color: #e5e5e5;  
    text-decoration: none;  
    transition: all 0.2s;  
    gap: 10px;  
}  
  
.dropdown-item:hover {  
    background: linear-gradient(to right, rgba(79, 155, 255, 0.1), rgba(79, 155, 255, 0.2));  
}  
  
.dropdown-divider {  
    height: 1px;  
    background-color: rgba(255, 255, 255, 0.1);  
    margin: 8px 0;  
}  
  
.dropdown-header {  
    padding: 6px 16px;  
    color: #8e9297;  
    font-size: 12px;  
    font-weight: 600;  
    text-transform: uppercase;  
}  
  
.size-option.active {  
    background-color: rgba(79, 155, 255, 0.2);  
    color: #4f9bff;  
}  
  
.chat-container {  
    width: 100%;  
    max-width: 100%;  
    flex: 1;  
    display: flex;  
    flex-direction: column;  
    background-color: transparent;  
    overflow: hidden;  
    position: relative;  
    z-index: 1; /* قيمة منخفضة لضمان ظهور القائمة فوقها */  
}  
  
.messages {  
    flex: 1;  
    overflow-y: auto;  
    padding: 20px;  
    display: flex;  
    flex-direction: column;  
    gap: 10px;  
}  
  
.message-container {  
    display: flex;  
    align-items: center;  
    gap: 10px;  
    transition: all 0.3s ease;  
    animation: slideIn 0.3s ease-out;  
}  
  
.message-container:hover {  
    transform: translateX(2px);  
}  
  
.avatar {  
    width: 35px;  
    height: 35px;  
    border-radius: 50%;  
    margin-right: 8px;  
    transition: all 0.3s ease;  
    border: 2px solid rgba(79, 155, 255, 0.3);  
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);  
}  
  
.avatar:hover {  
    transform: scale(1.1);  
}  
     
.message {  
    padding: 12px 16px;  
    border-radius: 20px;  
    max-width: 85%;  
    margin: 4px 0;  
    font-size: 15px;  
    line-height: 1.4;  
    word-wrap: break-word;  
    transition: all 0.3s ease;  
    border: 1px solid rgba(255, 255, 255, 0.1);  
    backdrop-filter: blur(8px);  
    -webkit-backdrop-filter: blur(8px);  
}  
  
.message:hover {  
    transform: scale(1.01);  
    box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);  
}  
  
.user {  
    background: linear-gradient(135deg, #4f9bff 0%, #2d5fee 100%);  
    margin-left: auto;  
    border-bottom-right-radius: 4px;  
    color: white;  
    box-shadow: 0 4px 15px rgba(79, 155, 255, 0.3);  
}  
  
.bot {  
    background: linear-gradient(135deg, #2e3338 0%, #373d48 100%);  
    margin-right: auto;  
    border-bottom-left-radius: 4px;  
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);  
}  
  
.input-container {  
    display: flex;  
    flex-wrap: wrap;  
    gap: 10px;  
    padding: 15px;  
    background: linear-gradient(to bottom, #282c34, #373d48);  
    backdrop-filter: blur(10px);  
    -webkit-backdrop-filter: blur(10px);  
    box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.2);  
    border-top: 1px solid rgba(255, 255, 255, 0.1);  
    align-items: center;  
    justify-content: center;  
    width: 100%;  
    position: sticky;  
    bottom: 0;  
}  
  
input,  
select {  
    flex: 1;  
    min-width: 120px;  
    padding: 12px 15px;  
    font-size: 15px;  
    border-radius: 20px;  
    background: rgba(56, 62, 71, 0.8);  
    border: 1px solid rgba(255, 255, 255, 0.1);  
    backdrop-filter: blur(4px);  
    -webkit-backdrop-filter: blur(4px);  
    color: white;  
    transition: all 0.3s ease;  
}  
  
select {  
    appearance: none;  
    -webkit-appearance: none;  
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");  
    background-repeat: no-repeat;  
    background-position: right 8px center;  
    background-size: 16px;  
    padding-right: 32px;  
}  
  
input:focus,  
select:focus {  
    transform: translateY(-1px);  
    border-color: #4f9bff;  
    box-shadow: 0 0 0 2px rgba(79, 155, 255, 0.2);  
    outline: none;  
}  
  
button {  
    background: linear-gradient(135deg, #4f9bff 0%, #2d5fee 100%);  
    border: 1px solid rgba(255, 255, 255, 0.1);  
    box-shadow: 0 4px 15px rgba(79, 155, 255, 0.2);  
    color: white;  
    padding: 12px 20px;  
    border-radius: 20px;  
    font-weight: 600;  
    cursor: pointer;  
    min-width: 120px;  
    transition: all 0.3s ease;  
}  
  
button:hover {  
    background: linear-gradient(135deg, #2d5fee 0%, #4f9bff 100%);  
    box-shadow: 0 8px 25px rgba(79, 155, 255, 0.3);  
    transform: translateY(-2px);  
}  
  
button:active {  
    transform: translateY(1px);  
}  
  
img {  
    max-width: 100%;  
    border-radius: 12px;  
    width: 300px;  
    height: 300px;  
    object-fit: cover;  
    margin: 8px 0;  
    border: 2px solid rgba(255, 255, 255, 0.1);  
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);  
    opacity: 0;  
    transform: scale(0.95);  
    animation: imageAppear 0.6s ease forwards;  
}  
  
@keyframes imageAppear {  
    0% {  
        opacity: 0;  
        transform: scale(0.95);  
        filter: blur(10px);  
    }  
    100% {  
        opacity: 1;  
        transform: scale(1);  
        filter: blur(0);  
    }  
}  
  
img:hover {  
    transform: scale(1.02);  
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);  
    transition: all 0.3s ease;  
}  
  
.download-btn {  
    margin-top: 15px;  
    background: linear-gradient(135deg, #4f9bff 0%, #2d5fee 100%);  
    border: 1px solid rgba(255, 255, 255, 0.1);  
    box-shadow: 0 4px 15px rgba(79, 155, 255, 0.2);  
    padding: 12px 24px;  
    border-radius: 25px;  
    font-weight: 600;  
    cursor: pointer;  
    transition: all 0.3s ease;  
    display: flex;  
    align-items: center;  
    justify-content: center;  
    gap: 8px;  
    width: 100%;  
}  
  
.download-btn:hover {  
    background: linear-gradient(135deg, #2d5fee 0%, #4f9bff 100%);  
    box-shadow: 0 8px 25px rgba(79, 155, 255, 0.3);  
    transform: translateY(-2px);  
}  
  
::-webkit-scrollbar {  
    width: 6px;  
}  
  
::-webkit-scrollbar-track {  
    background: rgba(33, 37, 41, 0.6);  
    border-radius: 10px;  
}  
  
::-webkit-scrollbar-thumb {  
    background: linear-gradient(135deg, #4f9bff 0%, #2d5fee 100%);  
    border-radius: 10px;  
}  
  
::-webkit-scrollbar-thumb:hover {  
    background: linear-gradient(135deg, #2d5fee 0%, #4f9bff 100%);  
}  
  
@keyframes fadeIn {  
    from {  
        opacity: 0;  
        transform: translateY(-10px);  
        filter: blur(5px);  
    }  
    to {  
        opacity: 1;  
        transform: translateY(0);  
        filter: blur(0);  
    }  
}  
  
@keyframes slideIn {  
    from {  
        opacity: 0;  
        transform: translateX(-20px);  
    }  
    to {  
        opacity: 1;  
        transform: translateX(0);  
    }  
}

@media (max-width: 768px) {} 
    .input-container {   
        display: grid;   
        grid-template-columns: 1fr 1fr;   
        gap: 12px;   
        padding: 15px;   
        background: linear-gradient(to bottom, #282c34, #373d48);   
    }   

  
    #userInput {  
        grid-column: 1 / -1;  
        width: 100%;  
        margin-bottom: 8px;  
        background: rgba(56, 62, 71, 0.8);  
        border: 1px solid rgba(255, 255, 255, 0.1);  
        padding: 15px;  
    }  
  
    #style, #model {  
        width: 100%;  
        min-width: 0;  
        padding: 12px;  
        font-size: 14px;  
        background: rgba(56, 62, 71, 0.8);  
        border: 1px solid rgba(255, 255, 255, 0.1);  
    }  
  
    #sendButton {  
        grid-column: 1 / -1;  
        width: 100%;  
        margin-top: 8px;  
        height: 40px;  
        background: linear-gradient(135deg, #4f9bff 0%, #2d5fee 100%);  
        padding: 15px;  
    }  
  
    select option {  
        font-size: 14px;  
    }  
  
    .message {  
        max-width: 90%;  
    }  
    .credits-section {
    display: flex;
    align-items: center;
    justify-content: center; /* محاذاة المحتوى في المنتصف */
    padding: 10px 16px;
    background: linear-gradient(to right, rgba(79, 155, 255, 0.1), rgba(79, 155, 255, 0.2));
    border-radius: 8px;
    margin: 8px 0;
}

.credits-section svg {
    width: 24px;
    height: 24px;
    margin-right: 10px;
    color: #4f9bff;
}

#credits-count {
    font-weight: bold;
    color: #4f9bff;

}

/* منع التمرير الأفقي */
body {
  overflow-x: hidden;
}

.ad-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100000;
    background: rgba(40, 44, 52, 0.98);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    padding: 15px;
    animation: fadeIn 0.3s ease;
    width: 300px;
    height: auto;
}

#mediaContainer {
    width: 100%;
    height: 270px;
    border-radius: 8px;
    overflow: hidden;
}

#mediaContainer img,
#mediaContainer video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: transparent;
    cursor: pointer;
    transition: transform 0.3s ease;
}

#mediaContainer img:hover,
#mediaContainer video:hover {
    transform: scale(1.02);
}

.close-ad {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 25px;
    height: 25px;
    background: linear-gradient(135deg, #4f9bff 0%, #2d5fee 100%);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    padding: 0;
    line-height: 1;
    z-index: 100001;
}

.close-ad:disabled {
    background: linear-gradient(135deg, #808080 0%, #606060 100%);
    cursor: not-allowed;
    transform: none;
}

.close-ad:disabled:hover {
    transform: none;
    background: linear-gradient(135deg, #808080 0%, #606060 100%);
}

.overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 99999;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

@media (max-width: 768px) {
    .ad-popup {
        width: 85%;
        max-width: 300px;
        padding: 10px;
    }
    
    #mediaContainer {
        height: auto;
        max-height: 270px;
    }
    
    .close-ad {
        width: 22px;
        height: 22px;
        font-size: 14px;
    }
    @keyframes fadeIn {   
    from {   
        opacity: 0;   
        visibility: hidden;
    }   
    to {   
        opacity: 1;   
        visibility: visible;
    }  
}
</style>
</head>
<body>  
    <!-- النافذة المنبثقة للإعلان -->
<div class="overlay" id="adOverlay"></div>

<div class="ad-popup" id="adPopup">
  <button class="close-ad" disabled>5</button>
  <a href="#" id="adLink" target="_blank">
    <div id="mediaContainer">
      <!-- سيتم إضافة الفيديو أو الصورة هنا ديناميكياً -->
    </div>
  </a>
</div>
    </a>
</div>
   
<div class="banner">  
    <img src="https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/image%20logo.png" class="banner-img">  
    <div class="dropdown">
        <button class="dropdown-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <div class="dropdown-menu">
            <!-- قسم الكريديتس -->
            <div class="credits-section">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <span>Credits: <span id="credits-count">0</span></span>
            </div>
            <div class="dropdown-divider"></div>

            <a href="#" class="dropdown-item" id="clearChatButton">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
                Clear Chat
            </a>
            
            <div class="dropdown-divider"></div>
            
            <div class="dropdown-header">Image Size</div>
            <a href="#" class="dropdown-item size-option" data-size="square">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
                SQUARE (1024×1024)
            </a>
            <a href="#" class="dropdown-item size-option" data-size="portrait">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                </svg>
                PORTRAIT (768×1024)
            </a>
            <a href="#" class="dropdown-item size-option" data-size="landscape">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="5" width="20" height="14" rx="2" ry="2"></rect>
                </svg>
                LANDSCAPE (1024×768)
            </a>
            
            <div class="dropdown-divider"></div>
            
            <a href="https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FPRAIVACY%20POLICY.html?alt=media&token=00c4ade1-4a9b-45e5-9f34-3dc0f5174476" class="dropdown-item" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                Privacy Policy
            </a>
            <a href="https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FTerms%20od%20use.html?alt=media&token=b1a22315-c0e6-4c0e-8d79-47433b5d6c88" class="dropdown-item" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Terms of Use
            </a>
            <a href="https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2Fmodels%20list.html?alt=media&token=d12a18ac-93ff-4853-865a-90adad64743f" class="dropdown-item" target="_blank"> 
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> 
                    <rect x="3" y="3" width="7" height="7"></rect> 
                    <rect x="14" y="3" width="7" height="7"></rect> 
                    <rect x="14" y="14" width="7" height="7"></rect> 
                    <rect x="3" y="14" width="7" height="7"></rect> 
                </svg> 
                Models List 
            </a>
            <a href="#" class="dropdown-item" onclick="showProfile()"> 
  <!-- أيقونة الملف الشخصي -->
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> 
    <circle cx="8" cy="5" r="3"></circle> <!-- رأس الشخص -->
    <path d="M2 16c0-3 3-5 6-5s6 2 6 5"></path> <!-- الجسم -->
  </svg> 
  My Account 
</a>

        </div>
    </div>  
</div>  
    <div class="chat-container">  
        <div class="messages" id="messages"></div>  
        <div class="input-container">  
            <input type="text" id="userInput" placeholder="Enter description...">  
                       <select id="style"> 
                <option value="None">None</option>
                <option value="Photorealism">Photorealism</option>
                <option value="Impressionism">Impressionism</option>
                <option value="Cubism">Cubism</option>
                <option value="Surrealism">Surrealism</option>
                <option value="Abstract">Abstract</option>
                <option value="Minimalism">Minimalism</option>
                <option value="Pop Art">Pop Art</option>
                <option value="Art Deco">Art Deco</option>
                <option value="Expressionism">Expressionism</option>
                <option value="Baroque">Baroque</option>
                <option value="Renaissance">Renaissance</option>
                <option value="Pointillism">Pointillism</option>
                <option value="Futurism">Futurism</option>
                <option value="Dadaism">Dadaism</option>
                <option value="Realism">Realism</option>
                <option value="Conceptual Art">Conceptual Art</option>
                <option value="Digital Collage">Digital Collage</option>
                <option value="Watercolor">Watercolor</option>
                <option value="Oil Painting">Oil Painting</option>
                <option value="Pencil Sketch">Pencil Sketch</option>
                <option value="Ink Drawing">Ink Drawing</option>
                <option value="Charcoal Art">Charcoal Art</option>
                <option value="Geometric Abstraction">Geometric Abstraction</option>
                <option value="Stencil Art">Stencil Art</option>
                <option value="Graffiti Art">Graffiti Art</option>
                <option value="Low Poly">Low Poly</option>
                <option value="3D Rendering">3D Rendering</option>
                <option value="Matte Painting">Matte Painting</option>
                <option value="Vintage Photography">Vintage Photography</option>
                <option value="Cinematic">Cinematic</option>
                <option value="Fantasy Art">Fantasy Art</option>
                <option value="Sci-Fi Art">Sci-Fi Art</option>
                <option value="Horror Art">Horror Art</option>
                <option value="Steampunk">Steampunk</option>
                <option value="Cyberpunk">Cyberpunk</option>
                <option value="Whimsical">Whimsical</option>
                <option value="Cartoon Style">Cartoon Style</option>
                <option value="Anime/Manga">Anime/Manga</option>
                <option value="Fantasy Realism">Fantasy Realism</option>
                <option value="Folk Art">Folk Art</option>
                <option value="Ethereal">Ethereal</option>
                <option value="Urban Art">Urban Art</option>
                <option value="Nature Illustration">Nature Illustration</option>
                <option value="Children’s Book Style">Children’s Book Style</option>
                <option value="Retro Vintage">Retro Vintage</option>
                <option value="High Contrast">High Contrast</option>
                <option value="Soft Focus">Soft Focus</option>
                <option value="HDR Photography">HDR Photography</option>
                <option value="Dreamlike">Dreamlike</option>
                <option value="Atmospheric">Atmospheric</option>
                <option value="Monochrome">Monochrome</option>
                <option value="Collage">Collage</option>
                <option value="Flat Design">Flat Design</option>
                <option value="Graphic Novel Style">Graphic Novel Style</option>
                <option value="8-Bit Art">8-Bit Art</option>
                <option value="Pixel Art">Pixel Art</option>
                <option value="Concept Art">Concept Art</option>
                <option value="Isometric">Isometric</option>
                <option value="Vexel Art">Vexel Art</option>
                <option value="Photo Manipulation">Photo Manipulation</option>
                <option value="Digital Painting">Digital Painting</option>
                <option value="Brush Stroke">Brush Stroke</option>
                <option value="Psychedelic Art">Psychedelic Art</option>
                <option value="Optical Illusion">Optical Illusion</option>
                <option value="Macro Photography">Macro Photography</option>
                <option value="Time-Lapse Art">Time-Lapse Art</option>
                <option value="Mixed Media">Mixed Media</option>
                <option value="Shadow Play">Shadow Play</option>
                <option value="Retro Futurism">Retro Futurism</option>
                <option value="Iconic Illustration">Iconic Illustration</option>
                <option value="Kawaii Style">Kawaii Style</option>
                <option value="Grunge Art">Grunge Art</option>
                <option value="Artisan Style">Artisan Style</option>
                <option value="Ambient Art">Ambient Art</option>
                <option value="Emotional Realism">Emotional Realism</option>
                <option value="Social Commentary">Social Commentary</option>
                <option value="Symbolism">Symbolism</option>
                <option value="Nature Photography">Nature Photography</option>
                <option value="Cinematic Lighting">Cinematic Lighting</option>
                <option value="Color Field">Color Field</option>
                <option value="Line Work">Line Work</option>
                <option value="Textured Art">Textured Art</option>
                <option value="Chalkboard Style">Chalkboard Style</option>
                <option value="Surreal Portraiture">Surreal Portraiture</option>
                <option value="Fantasy Landscape">Fantasy Landscape</option>
                <option value="Abstract Portrait">Abstract Portrait</option>
                <option value="Digital Illustration">Digital Illustration</option>
                <option value="Bokeh Effect">Bokeh Effect</option>
                <option value="Vibrant Color Palette">Vibrant Color Palette</option>
                <option value="Soft Pastels">Soft Pastels</option>
                <option value="High Saturation">High Saturation</option>
                <option value="Low Contrast">Low Contrast</option>
                <option value="Textured Background">Textured Background</option>
                <option value="Soft Lighting">Soft Lighting</option>
                <option value="Urban Photography">Urban Photography</option>
                <option value="Black and White">Black and White</option>
                <option value="Warm Tones">Warm Tones</option>
                <option value="Cool Tones">Cool Tones</option>
                <option value="Dynamic Composition">Dynamic Composition</option>
                <option value="Conceptual Photography">Conceptual Photography</option>
                <option value="Fantasy Realism">Fantasy Realism</option>
                <option value="Iconic Symbols">Iconic Symbols</option>
                <option value="Ethereal Landscapes">Ethereal Landscapes</option>
                <option value="Whimsical Characters">Whimsical Characters</option>
                <option value="Fantasy Creatures">Fantasy Creatures</option>
                <option value="Celestial Art">Celestial Art</option>
                <option value="Mythical Beasts">Mythical Beasts</option>
                <option value="Dreamscapes">Dreamscapes</option>
                <option value="Nature Patterns">Nature Patterns</option>
                <option value="Urban Landscapes">Urban Landscapes</option>
                <option value="Vintage Illustrations">Vintage Illustrations</option>
                <option value="Soft Focus Portraits">Soft Focus Portraits</option>
                <option value="Character Design">Character Design</option>
                <option value="Motion Graphics">Motion Graphics</option>
                <option value="Storybook Style">Storybook Style</option>
                <option value="Retro Illustrations">Retro Illustrations</option>
                <option value="Scientific Illustration">Scientific Illustration</option>
                <option value="Detailed Line Art">Detailed Line Art</option>
                <option value="Ethereal Portraits">Ethereal Portraits</option>
                <option value="Playful Designs">Playful Designs</option>
                <option value="Digital Sculpture">Digital Sculpture</option>
                <option value="Conceptual Portraits">Conceptual Portraits</option>
                <option value="Atmospheric Landscapes">Atmospheric Landscapes</option>
                <option value="Hyperrealistic">Hyperrealistic</option>
                <option value="Fantasy Worlds">Fantasy Worlds</option>
                <option value="Abstract Patterns">Abstract Patterns</option>
                <option value="Textured Illustrations">Textured Illustrations</option>
                <option value="Narrative Art">Narrative Art</option>
                <option value="Cinematic Scenes">Cinematic Scenes</option>
                <option value="Conceptual Surrealism">Conceptual Surrealism</option>
                <option value="Art Nouveau">Art Nouveau</option>
                <option value="Art Brut">Art Brut</option>
                <option value="Visual Poetry">Visual Poetry</option>
                <option value="Storytelling Art">Storytelling Art</option>
                <option value="Color Exploration">Color Exploration</option>
                <option value="Emotional Expression">Emotional Expression</option>
                <option value="Cultural Art">Cultural Art</option>
                <option value="Historical Styles">Historical Styles</option>
                <option value="Avant-Garde">Avant-Garde</option>
                <option value="Experimental Art">Experimental Art</option>
                <option value="Multi-Dimensional">Multi-Dimensional</option>
                <option value="Interactive Art">Interactive Art</option>
                <option value="Sound Visualizations">Sound Visualizations</option>
                <option value="Nature Scapes">Nature Scapes</option>
                <option value="Cosmic Art">Cosmic Art</option>
                <option value="Fantasy Portraits">Fantasy Portraits</option>
                <option value="Surreal Landscapes">Surreal Landscapes</option>
                <option value="Dramatic Lighting">Dramatic Lighting</option>
                <option value="Graphic Illustrations">Graphic Illustrations</option>
                <option value="Conceptual Landscape">Conceptual Landscape</option>
                <option value="Playful Typography">Playful Typography</option>
                <option value="Visual Metaphors">Visual Metaphors</option>
                <option value="Symbolic Imagery">Symbolic Imagery</option>
                <option value="Surreal Figures">Surreal Figures</option>
                <option value="Futuristic Landscapes">Futuristic Landscapes</option>
                <option value="Urban Illustrations">Urban Illustrations</option>
                <option value="Organic Shapes">Organic Shapes</option>
                <option value="Geometric Patterns">Geometric Patterns</option>
                <option value="Chaotic Art">Chaotic Art</option>
                <option value="Geometric Landscapes">Geometric Landscapes</option>
                <option value="Expressive Brushwork">Expressive Brushwork</option>
                <option value="Dynamic Color Usage">Dynamic Color Usage</option>
                <option value="Contrast Exploration">Contrast Exploration</option>
                <option value="Visual Storytelling">Visual Storytelling</option>
                <option value="Kinetic Art">Kinetic Art</option>
                <option value="Digital Collage Art">Digital Collage Art</option>
                <option value="Experimental Photography">Experimental Photography</option>
                <option value="Futuristic Design">Futuristic Design</option>
                <option value="Collage Portraits">Collage Portraits</option>
                <option value="Cultural Symbolism">Cultural Symbolism</option>
                <option value="Fantasy Elements">Fantasy Elements</option>
                <option value="Vivid Imagery">Vivid Imagery</option>
                <option value="Layered Textures">Layered Textures</option>
                <option value="Abstract Landscapes">Abstract Landscapes</option>
                <option value="Stylized Portraits">Stylized Portraits</option>
                <option value="Visual Rhythms">Visual Rhythms</option>
                <option value="Colorful Patterns">Colorful Patterns</option>
                <option value="Narrative Illustration">Narrative Illustration</option>
                <option value="Symbolic Representation">Symbolic Representation</option>
                <option value="Unconventional Materials">Unconventional Materials</option>
                <option value="Poetic Imagery">Poetic Imagery</option>
                <option value="Nature's Palette">Nature's Palette</option>
                <option value="Urban Landscapes">Urban Landscapes</option>
                <option value="Contemporary Art">Contemporary Art</option>
                <option value="Post-Modern Art">Post-Modern Art</option>
                <option value="Artistic Photography">Artistic Photography</option>
                <option value="Graphic Realism">Graphic Realism</option>
                <option value="Conceptual Abstraction">Conceptual Abstraction</option>
                <option value="Surrealist Portraits">Surrealist Portraits</option>
                <option value="Playful Surrealism">Playful Surrealism</option>
                <option value="Dreamlike Imagery">Dreamlike Imagery</option>
                <option value="Ethereal Landscapes">Ethereal Landscapes</option>
                <option value="Mythological Themes">Mythological Themes</option>
                <option value="Mystical Art">Mystical Art</option>
                <option value="Intricate Designs">Intricate Designs</option>
                <option value="Nature's Geometry">Nature's Geometry</option>
                <option value="Visual Abstraction">Visual Abstraction</option>
                <option value="Cinematic Illustrations">Cinematic Illustrations</option>
                <option value="Fashion Illustration">Fashion Illustration</option>
                <option value="Cultural Exploration">Cultural Exploration</option>
                <option value="Editorial Illustration">Editorial Illustration</option>
                <option value="Children’s Illustration">Children’s Illustration</option>
                <option value="Comic Book Art">Comic Book Art</option>
                <option value="Graphic Novel Art">Graphic Novel Art</option>
                <option value="Zine Art">Zine Art</option>
                <option value="Collage Illustration">Collage Illustration</option>
                <option value="Conceptual Animal Art">Conceptual Animal Art</option>
                <option value="Nature-Based Art">Nature-Based Art</option>
                <option value="Abstract Floral Art">Abstract Floral Art</option>
                <option value="Still Life Photography">Still Life Photography</option>
                <option value="Black and White Photography">Black and White Photography</option>
                <option value="Candid Photography">Candid Photography</option>
                <option value="Portrait Photography">Portrait Photography</option>
                <option value="Fashion Collage">Fashion Collage</option>
                <option value="Montage">Montage</option>
                <option value="Digital Textures">Digital Textures</option>
                <option value="Visual Effects Art">Visual Effects Art</option>
                <option value="2D Animation">2D Animation</option>
                <option value="3D Animation">3D Animation</option>
                <option value="Character Animation">Character Animation</option></option>
</select>
            <select id="model"> 
                <option value=" ">Default</option>
                <option value="in the style of DALL·E 3">DALL-E 3</option> 
                <option value="in the style of Stable Diffusion XL (SDXL)">Stable Diffusion XL (SDXL)</option> 
                <option value="in the style of Midjourney v6">Midjourney v6</option> 
                <option value="in the style of Imagen by Google DeepMind">Imagen (Google DeepMind)</option> 
                <option value="in the style of Runway Gen-2">Runway Gen-2</option> 
                <option value="in the style of Dream by Wombo">Dream by Wombo</option> 
                <option value="Create an image that contains clearly readable and accurately rendered text elements, ensuring the text is an integral and visually clear part of the image in the style of DeepFloyd IF">DeepFloyd IF</option> 
                <option value="in the style of Parti by Google">Parti (Google)</option> 
                <option value="in the cartoon style of Toonify">Toonify (Cartoon)</option> 
                <option value="in the anime style of Nijijourney">Nijijourney (Anime)</option> 
                <option value="in the advanced rendering style of Flux Dev">Flux Dev</option> 
                <option value="in the fast-rendering style of Flux Schnell">Flux Schnell</option> 
                <option value="in the stylized realism of Phoenix 0.9">Phoenix 0.9</option> 
                <option value="in the high-fidelity realism of Phoenix 1.0">Phoenix 1.0</option>                
            </select>
            <button id="sendButton">Send</button>  
        </div>  
    </div> 
    <div id="authOverlay" class="overlay"></div>

    <!-- نافذة تسجيل الدخول / التسجيل -->
<div id="authPopup" class="ad-popup" style="z-index: 100001;"> 
  <button class="close-ad" onclick="logout()">×</button> 
  <h2 style="text-align: center; margin-bottom: 10px;">Login / Register</h2> 
  <input type="email" id="email" placeholder="Email" style="margin-bottom: 10px;"> 
  <input type="password" id="password" placeholder="Password" style="margin-bottom: 10px;"> 
  <button onclick="signIn()" style="margin-bottom: 10px;">Login</button> 
  <button onclick="signUp()">Register</button> 
  <a href="#" onclick="forgotPassword()" style="display: block; text-align: center; margin-top: 10px; color: #4f9bff;">Forgot Password?</a> 
  <p id="auth-status" style="text-align: center; margin-top: 10px; color: #4f9bff;"></p> 
</div> 

<!-- نافذة الملف الشخصي -->
<div id="profilePopup" class="ad-popup" style="z-index: 100001;"> 
  <button class="close-ad" onclick="closeProfile()">×</button> 
  <h3 style="margin-bottom: 10px;">My Account</h3> 

  <input type="text" id="profileName" placeholder="Full Name" style="margin-bottom: 10px;"> 
  <input type="email" id="profileEmail" placeholder="Email" style="margin-bottom: 10px;" disabled> 
  <input type="tel" id="profilePhone" placeholder="Phone Number" style="margin-bottom: 10px;"> 

  <select id="profileCountry" style="margin-bottom: 10px;"> 
    <option value="">Select Country</option> 
    <!-- سيتم تعبئتها عبر JavaScript -->
  </select> 

  <div style="margin-bottom: 10px;"> 
    <p>Total Credits Used: <span id="totalCreditsUsed">0</span></p> 
    <p>Current Credits: <span id="currentCredits">0</span></p> 
  </div> 

  <h4 style="margin: 15px 0 10px;">Change Password</h4> 
  <input type="password" id="currentPassword" placeholder="Current Password" style="margin-bottom: 10px;"> 
  <input type="password" id="newPassword" placeholder="New Password" style="margin-bottom: 10px;"> 

  <button onclick="updateProfile()" style="margin-bottom: 10px;">Update Profile</button> 
  <button onclick="changePassword()" style="margin-bottom: 10px;">Change Password</button> 
  <button onclick="logout()" style="background: #ff4f4f;">Logout</button> 

  <p id="profile-status" style="margin-top: 10px; color: #4f9bff;"></p> 
</div>

</body>
</html> 
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>


<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://zbfweddofzmfbgdprdem.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpiZndlZGRvZnptZmJnZHByZGVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyMDIxODgsImV4cCI6MjA2MDc3ODE4OH0.Eo2VS6WkSZeYnZE4D8i6V6UsNRzWAN0BwkG1GJ3O8lc'
  );

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  async function signUp() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!isValidEmail(email)) {
      document.getElementById('auth-status').textContent = "Invalid email format.";
      return;
    }

    if (password.length < 6) {
      document.getElementById('auth-status').textContent = "Password too short (min 6 chars).";
      return;
    }

    try {
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            credits_used: 0,
            total_credits: 10,
          }
        }
      });
      if (error) throw error;
      document.getElementById('auth-status').textContent = "Registration successful! Please check your email.";
    } catch (error) {
      document.getElementById('auth-status').textContent = error.message;
    }
  }

  async function signIn() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    try {
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      closeAuthPopup();
      await loadUserData();
    } catch (error) {
      document.getElementById('auth-status').textContent = `❌ ${error.message}`;
    }
  }

  async function forgotPassword() {
    const email = document.getElementById('email').value.trim();
    if (!isValidEmail(email)) {
      document.getElementById('auth-status').textContent = "Please enter a valid email";
      return;
    }

    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/reset-password'
      });
      if (error) throw error;
      document.getElementById('auth-status').textContent = "Password reset instructions sent to your email";
    } catch (error) {
      document.getElementById('auth-status').textContent = error.message;
    }
  }

  async function changePassword() {
    const newPassword = document.getElementById('newPassword').value;

    if (newPassword.length < 6) {
      document.getElementById('profile-status').textContent = "New password must be at least 6 characters";
      return;
    }

    try {
      const { error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) throw error;
      document.getElementById('profile-status').textContent = "Password updated successfully";
    } catch (error) {
      document.getElementById('profile-status').textContent = error.message;
    }
  }

// IndexedDB Initialization
let db;
initializeDatabase();

function initializeDatabase() {
    const request = indexedDB.open('ATIGAIIMAGESGENERATOR', 1);

    request.onerror = (event) => {
        console.error("Database error: " + event.target.errorCode);
    };

    request.onsuccess = (event) => {
        db = event.target.result;
        console.log("Database opened successfully");
        loadMessages();
    };

    request.onupgradeneeded = (event) => {
        db = event.target.result;
        if (!db.objectStoreNames.contains("messages")) {
            db.createObjectStore("messages", { keyPath: "id", autoIncrement: true });
        }
    };
}
function initializeCredits() {
  const lastUpdate = localStorage.getItem('lastCreditUpdate');
  const now = Date.now();

  // إذا لا يوجد وقت تحديث سابق، أو مرت 6 ساعات (21600000 ميلي ثانية)
  if (!lastUpdate || now - parseInt(lastUpdate) >= 6 * 60 * 60 * 1000) {
    const newCredits = 10; // العدد الجديد كل 6 ساعات
    localStorage.setItem('credits', newCredits);
    localStorage.setItem('totalCreditsUsed', 0); // تصفير الاستخدام إذا تحب
    localStorage.setItem('lastCreditUpdate', now);
  }
}


// Load messages from IndexedDB

function loadMessages() {
    if (!db) {
        console.error("Database not initialized");
        setTimeout(loadMessages, 10); // Retry after a delay
        return;
    }

    const transaction = db.transaction(["messages"], "readonly");
    const store = transaction.objectStore("messages");
    const request = store.getAll();

    request.onsuccess = (event) => {
        const savedConversation = event.target.result || [];
        const messages = document.getElementById("messages");
        
        // Clear existing messages first
        messages.innerHTML = '';

        if (savedConversation.length === 0) {
            addWelcomeMessage(messages);
        } else {
            savedConversation.forEach(item => {
                displayMessage(item, messages);
            });
            
            // Scroll to bottom after loading messages
            messages.scrollTop = messages.scrollHeight;
        }

        // Manage credits after loading messages
        manageMonthlyCredits();

    };

    request.onerror = (event) => {
        console.error("Error loading messages:", event.target.error);
        addWelcomeMessage(document.getElementById("messages"));
    };
}

function addWelcomeMessage(messages) {
    const botContainer = document.createElement("div");
    botContainer.classList.add("message-container");
    
    const botAvatar = createBotAvatar();
    botContainer.appendChild(botAvatar);
    
    const botMessage = document.createElement("div");
    botMessage.classList.add("message", "bot");
    botMessage.innerHTML = `<p>🎨 Welcome to ATIGAI – Your smart platform to turn ideas into stunning visuals with precision and limitless creativity! 🤖✨</p>`;
    
    botContainer.appendChild(botMessage);
    messages.appendChild(botContainer);

   
}



function displayMessage(item, messages) {
    const messageContainer = document.createElement("div");
    messageContainer.classList.add("message-container");

    if (item.type === "user") {
        const userMessage = document.createElement("div");
        userMessage.classList.add("message", "user");
        userMessage.textContent = item.content;
        messageContainer.appendChild(userMessage);
        messageContainer.style.justifyContent = "flex-end";
    } else if (item.type === "bot") {
        const botAvatar = createBotAvatar();
        messageContainer.appendChild(botAvatar);
        
        const botMessage = document.createElement("div");
        botMessage.classList.add("message", "bot");
        
        // Handle different types of bot messages
        if (item.content === "Welcome") {
            botMessage.innerHTML = `<p>🎨 Welcome to ATIGAI – Your smart platform to turn ideas into stunning visuals with precision and limitless creativity! 🤖✨</p>`;
        } else if (typeof item.content === 'object' && item.content.imageUrl) {
            // This is an image message
            const image = document.createElement("img");
            image.src = item.content.imageUrl;
            botMessage.appendChild(image);

            const imageInfo = document.createElement("div");
            imageInfo.innerHTML = `
                <p><strong>Prompt:</strong> ${item.content.prompt}</p>
                <p><strong>Style:</strong> ${item.content.style}</p>
                <p><strong>Model:</strong> ${item.content.model}</p>
                <p><strong>Date:</strong> ${item.content.date}</p>
                <p><strong>Credits Remaining:</strong> ${item.content.credits}</p>
            `;
            botMessage.appendChild(imageInfo);
            const downloadBtn = document.createElement("button"); 
            downloadBtn.classList.add("download-btn"); 
            downloadBtn.textContent = "Download Photo"; 
            downloadBtn.addEventListener("click", () => { 
                if (item.content.imageUrl) { 
                    const link = document.createElement("a"); 
                    link.href = item.content.imageUrl; 
                    link.download = "image.png"; 
                    link.click(); 
                } 
            }); 
            botMessage.appendChild(downloadBtn); 
        } else { 
            // Regular text message 
            botMessage.textContent = item.content; 
        } 
         
        messageContainer.appendChild(botMessage); 
        messageContainer.style.justifyContent = "flex-start"; 
    } 
 
    messages.appendChild(messageContainer); 
} 


// Credit Management
let credits = 10;

function manageDailyCredits() {
    // Get stored values
    const storedCredits = localStorage.getItem('credits');
    const lastAccessTime = localStorage.getItem('lastAccessTime');
    const currentTime = Date.now();
    
    if (storedCredits !== null) {
        credits = parseInt(storedCredits);
    } else {
        credits = 10;
        localStorage.setItem('credits', credits);
    }
    
    // Check if we should reset credits (after 6 hours)
    if (lastAccessTime) {
        const sixHoursInMillis = 6 * 60 * 60 * 1000;
        if (currentTime - parseInt(lastAccessTime) >= sixHoursInMillis) {
            credits = 10;
            localStorage.setItem('credits', credits);
        }
    }
    
    // Always update the last access time
    localStorage.setItem('lastAccessTime', currentTime);
    
    // Update the UI
    updateCreditsDisplay();
}

// Save message to IndexedDB
function addMessageToConversation(type, content) {
    if (!db) {
        console.error("Database not initialized");
        return;
    }

    const transaction = db.transaction(["messages"], "readwrite");
    const store = transaction.objectStore("messages");
    const message = { type, content, timestamp: Date.now() };
    
    const request = store.add(message);
    
    request.onerror = (event) => {
        console.error("Error adding message to IndexedDB:", event.target.error);
    };
}

// Modified image generation to properly update credits
async function uploadAndDisplayImage(imageBlob, prompt, style, model, botMessage) {
    try {
        const fileName = `ATIGAI_${Date.now()}_${Math.floor(Math.random() * 1000000)}.png`;
const { data, error } = await supabase.storage
  .from('generated-images') // اسم البَكَت في Supabase
  .upload(fileName, imageBlob, {
    contentType: 'image/png'
  });

if (error) {
  console.error('Upload error:', error);
  botMessage.innerHTML = "❌ Failed to upload image.";
  return;
}

const { data: urlData } = supabase.storage.from('generated-images').getPublicUrl(fileName);
const imageUrl = urlData.publicUrl;

        // Deduct a credit and update local storage
        credits--;
        localStorage.setItem('credits', credits);
        localStorage.setItem('lastAccessTime', Date.now());
        updateCreditsDisplay();

        botMessage.innerHTML = "";
        const imgElement = document.createElement("img");
        imgElement.src = imageUrl;
        botMessage.appendChild(imgElement);

        const imageInfo = document.createElement("div");
        imageInfo.innerHTML = `
            <p><strong>Prompt:</strong> ${prompt}</p>
            <p><strong>Style:</strong> ${style}</p>
            <p><strong>Model:</strong> ${modelMap[model] || model}</p>
            <p><strong>Date:</strong> ${new Date().toLocaleString('en-US', { hour12: false })}</p>
            <p><strong>Credits Remaining:</strong> ${credits}</p>
        `;
        botMessage.appendChild(imageInfo);

        const downloadBtn = document.createElement("button");
        downloadBtn.classList.add("download-btn");
        downloadBtn.textContent = "Download Photo";
        botMessage.appendChild(downloadBtn);

        downloadBtn.addEventListener("click", function () {
            const link = document.createElement("a");
            link.href = imageUrl;
            link.download = "image.png";
            link.click();
        });

        // Save bot message with image to IndexedDB
        addMessageToConversation("bot", {
            imageUrl: imageUrl,
            prompt: prompt,
            style: style,
            model: modelMap[model] || model,
            date: new Date().toLocaleString('en-US', { hour12: false }),
            credits: credits
        });
        
        // Make sure messages container scrolls to bottom to show the new image
        const messages = document.getElementById("messages");
        messages.scrollTop = messages.scrollHeight;
    } catch (error) {
        console.error("Error uploading image:", error);
        botMessage.innerHTML = "Failed to Generate image. Please try again.";
    }
}

// Modified send message function to check credits before proceeding
async function sendMessage() {
    const session = await supabase.auth.getSession();
if (!session.data.session) {
  showAuthPopup();
  return;
}
    const userInput = document.getElementById("userInput");
    const userInputValue = userInput.value.trim();
    if (!userInputValue) return;

    const messages = document.getElementById("messages");

    if (credits <= 0) {
        showCreditLimitMessage(messages);
        return;
    }

    const style = document.getElementById("style").value;
    const model = document.getElementById("model").value;
    const seed = Math.floor(Math.random() * 1000000);

    const sizeOptions = document.querySelectorAll('.size-option');
    let size = 'square';
    sizeOptions.forEach(option => {
        if (option.classList.contains('active')) {
            size = option.dataset.size;
        }
    });

    let width, height;
    switch (size) {
        case "portrait":
            width = 2160;
            height = 3840;
            break;
        case "landscape":
            width = 3840;
            height = 2160;
            break;
        case "square":
        default:
            width = 3840;
            height = 3840;
            break;
    }

    const sendButton = document.getElementById("sendButton");
    sendButton.disabled = true;

    // Create and display user message
    const userContainer = document.createElement("div");
    userContainer.classList.add("message-container");
    userContainer.style.justifyContent = "flex-end";
    
    const userMessage = document.createElement("div");
    userMessage.classList.add("message", "user");
    userMessage.textContent = userInputValue;
    
    userContainer.appendChild(userMessage);
    messages.appendChild(userContainer);
    
    // Save user message to IndexedDB
    addMessageToConversation("user", userInputValue);

    // Create and display bot message container
    const botContainer = document.createElement("div");
    botContainer.classList.add("message-container");
    
    const botAvatar = createBotAvatar();
    botContainer.appendChild(botAvatar);
    
    const botMessage = document.createElement("div");
    botMessage.classList.add("message", "bot");
    
    const timerText = document.createElement("div");
    timerText.classList.add("timer");
    timerText.textContent = "Generating in 30s...";
    botMessage.appendChild(timerText);
    
    botContainer.appendChild(botMessage);
    messages.appendChild(botContainer);
    
    // Scroll to bottom
    messages.scrollTop = messages.scrollHeight;

    // Start countdown and generate image
    countdownAndGenerateImage(userInputValue, style, model, seed, botMessage, width, height);

    userInput.value = "";
}

function showCreditLimitMessage(messages) {
    const botContainer = document.createElement("div");
    botContainer.classList.add("message-container");

    const botAvatar = createBotAvatar();
    botContainer.appendChild(botAvatar);
    
    const botMessage = document.createElement("div");
    botMessage.classList.add("message", "bot");

    const lastAccessTime = parseInt(localStorage.getItem('lastAccessTime')) || Date.now();
    const currentTime = Date.now();
    const sixHoursInMillis = 6 * 60 * 60 * 1000;

    const timeRemaining = sixHoursInMillis - (currentTime - lastAccessTime);
    const hoursRemaining = Math.floor(timeRemaining / (1000 * 60 * 60));
    const minutesRemaining = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));

    botMessage.innerHTML = `You have reached the maximum number of allowable requests. You can generate more images after <span style="color: #4f9bff; font-weight: bold;">${hoursRemaining}h ${minutesRemaining}m</span>.`;

    botContainer.appendChild(botMessage);
    messages.appendChild(botContainer);
    
    // Save this message to conversation history
    addMessageToConversation("bot", `You have reached the maximum number of allowable requests. You can generate more images after ${hoursRemaining}h ${minutesRemaining}m.`);
    
    // Scroll to bottom
    messages.scrollTop = messages.scrollHeight;
}
function createBotAvatar() {
    const botAvatar = document.createElement("img");
    botAvatar.classList.add("avatar");
    botAvatar.src = "https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/Avatar%20ico_remastered.jpg";
    return botAvatar;
}

// Model Map
const modelMap = {
    " ": "ATIGAI (Default)",
    "in the style of DALL·E 3": "DALL-E 3",
    "in the style of Stable Diffusion XL (SDXL)": "Stable Diffusion XL (SDXL)",
    "in the style of Midjourney v6": "Midjourney v6",
    "in the style of Imagen by Google DeepMind": "Imagen (Google DeepMind)",
    "in the style of Runway Gen-2": "Runway Gen-2",
    "in the style of Dream by Wombo": "Dream by Wombo",
    "Create an image that contains clearly readable and accurately rendered text elements, ensuring the text is an integral and visually clear part of the image in the style of DeepFloyd IF": "DeepFloyd IF",
    "in the style of Parti by Google": "Parti (Google)",
    "in the cartoon style of Toonify": "Toonify (Cartoon)",
    "in the anime style of Nijijourney": "Nijijourney (Anime)",
    "in the advanced rendering style of Flux Dev": "Flux Dev",
    "in the fast-rendering style of Flux Schnell": "Flux Schnell",
    "in the stylized realism of Phoenix 0.9": "Phoenix 0.9",
    "in the high-fidelity realism of Phoenix 1.0": "Phoenix 1.0"
};

// Event Listeners Setup
document.addEventListener('DOMContentLoaded', () => {
    setupDropdown();
    setupSendMessage();
    setupClearChat();
    setupAdPopup();
    loadMessages();
    checkUser();
});
document.addEventListener('DOMContentLoaded', () => {
  manageDailyCredits(); // تحديث الكريديت حسب الوقت
  updateCreditsDisplay(); // عرض الكريديت
});


function checkAndResetMonthlyUsage() {
  const lastResetDate = localStorage.getItem('monthlyResetDate');
  const now = new Date();

  let shouldReset = false;

  if (lastResetDate) {
    const lastDate = new Date(lastResetDate);
    // تحقق هل تغير الشهر أو السنة
    shouldReset = now.getMonth() !== lastDate.getMonth() || now.getFullYear() !== lastDate.getFullYear();
  } else {
    shouldReset = true; // أول مرة
  }

  if (shouldReset) {
    localStorage.setItem('totalCreditsUsed', '0');
    localStorage.setItem('monthlyResetDate', now.toISOString());
  }
}


// Dropdown setup
function setupDropdown() {
    const dropdown = document.querySelector('.dropdown');
    const dropdownToggle = dropdown.querySelector('.dropdown-toggle');
    const sizeOptions = document.querySelectorAll('.size-option');
    let currentSize = 'square';

    dropdownToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
            dropdown.classList.remove('active');
        }
    });

    sizeOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            e.preventDefault();
            currentSize = option.dataset.size;
            setActiveSizeOption(sizeOptions, currentSize);
            dropdown.classList.remove('active');
        });
    });

    setActiveSizeOption(sizeOptions, currentSize);
}

function setActiveSizeOption(sizeOptions, currentSize) {
    sizeOptions.forEach(option => {
        option.classList.toggle('active', option.dataset.size === currentSize);
    });
}

// Sending Messages
function setupSendMessage() {
    const userInput = document.getElementById("userInput");
    const sendButton = document.getElementById("sendButton");

    sendButton.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });
}



async function countdownAndGenerateImage(prompt, style, model, seed, botMessage, width, height) {
    let countdown = 30;
    const timerText = botMessage.querySelector('.timer');
    const sendButton = document.getElementById("sendButton");
    sendButton.disabled = true; // تعطيل الزر في البداية

    const imagePromise = generateImage(prompt, style, model, seed, botMessage, width, height, true);

    const countdownInterval = setInterval(async () => {
        countdown--;
        timerText.textContent = `Generating in ${countdown}s...`;

        if (countdown <= 0) {
            clearInterval(countdownInterval);
            timerText.textContent = "";

            try {
                const finalImage = await imagePromise;
                if (finalImage) {
                    await uploadAndDisplayImage(finalImage, prompt, style, model, botMessage);
                }
            } catch (error) {
                console.error("Error in image generation:", error);
                botMessage.innerHTML = "Failed to generate image. Please try again.";
            } finally {
                // تأكد من إعادة تفعيل الزر حتى في حالة حدوث خطأ
                sendButton.disabled = false;
            }
        }
    }, 1000);
}

async function generateImage(prompt, style, model, seed, botMessage, width, height, backgroundMode = false) {
    try {
        const response = await fetch(`https://proxy-server-1-rufp.onrender.com/generate?prompt=${encodeURIComponent(prompt)}, ${encodeURIComponent(style)}, High Quality Sharp & Details 100% ${encodeURIComponent(model)}&seed=${seed}&width=${width}&height=${height}&enhance=true`);
        if (!response.ok) throw new Error("Failed to generate image");

        const imageBlob = await response.blob();
        const image = await createImageFromBlob(imageBlob);
        const cleanImage = await removeMetadata(image);
        const enhancedImage = await applyQualityEffects(cleanImage);

        if (!backgroundMode) {
  await updateCreditsStats();
}


        if (model === " ") {
            const watermarkedImage = await addWatermark(enhancedImage);
            return watermarkedImage;
        } else {
            return enhancedImage;
        }

    } catch (error) {
        console.error("Error generating image:", error);
        if (!backgroundMode) {
            botMessage.innerHTML = "The API failed to create the image. Please try again.";
        }
        return null;

    } finally {
        if (!backgroundMode) {
            const sendButton = document.getElementById("sendButton");
            sendButton.disabled = false;
        }
    }
}


function createImageFromBlob(blob) {
    return new Promise((resolve, reject) => {
        const image = new Image();
        image.crossOrigin = "Anonymous";
        image.src = URL.createObjectURL(blob);
        image.onload = () => resolve(image);
        image.onerror = (e) => reject(e);
    });
}

function removeMetadata(image) {
    return new Promise((resolve) => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);
        canvas.toBlob((blob) => resolve(blob), "image/png");
    });
}

async function applyQualityEffects(imageBlob) {
    return new Promise((resolve) => {
        const image = new Image();
        image.crossOrigin = "Anonymous";
        image.src = URL.createObjectURL(imageBlob);
        image.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);

            applySharpen(ctx, canvas, 0.3);
            applyGrain(ctx, canvas, 0.02);

            canvas.toBlob((blob) => resolve(blob), "image/png");
        };
    });
}

function applySharpen(ctx, canvas, amount) {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    const width = canvas.width;
    const height = canvas.height;

    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            const idx = (y * width + x) * 4;
            for (let c = 0; c < 3; c++) {
                const current = data[idx + c];
                const top = data[idx - width * 4 + c];
                const bottom = data[idx + width * 4 + c];
                const left = data[idx - 4 + c];
                const right = data[idx + 4 + c];
                const sharpened = 5 * current - top - bottom - left - right;
                data[idx + c] = Math.max(0, Math.min(255, (1 - amount) * data[idx + c] + amount * sharpened));
            }
        }
    }
    ctx.putImageData(imageData, 0, 0);
}

function applyGrain(ctx, canvas, intensity) {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
        const grainValue = (Math.random() * 2 - 1) * intensity * 255;
        data[i] = Math.max(0, Math.min(255, data[i] + grainValue));
        data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + grainValue));
        data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + grainValue));
    }
    ctx.putImageData(imageData, 0, 0);
}

function addWatermark(imageBlob) {
    return new Promise((resolve) => {
        const image = new Image();
        image.crossOrigin = "Anonymous";
        image.src = URL.createObjectURL(imageBlob);
        image.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);

            const watermark = new Image();
            watermark.crossOrigin = "Anonymous";
            watermark.src = "https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/image%20logo.png";
            watermark.onload = () => {
                const scaleFactor = 0.05;
                const watermarkWidth = watermark.width * scaleFactor;
                const watermarkHeight = watermark.height * scaleFactor;
                ctx.globalAlpha = 0.5;
                ctx.drawImage(watermark, 10, canvas.height - watermarkHeight - 10, watermarkWidth, watermarkHeight);
                ctx.globalAlpha = 1;
                canvas.toBlob((blob) => resolve(blob), "image/png");
            };
        };
    });
}

// Clear Chat
function setupClearChat() {
    const clearChatButton = document.getElementById("clearChatButton");
    if (clearChatButton) {
        clearChatButton.addEventListener("click", clearChat);
    }
}

function clearChat() {
    if (!db) {
        console.error("Database not initialized");
        return;
    }

    const transaction = db.transaction(["messages"], "readwrite");
    const store = transaction.objectStore("messages");
    const clearRequest = store.clear();

    clearRequest.onsuccess = () => {
        console.log("Chat history cleared");
        const messages = document.getElementById("messages");
        messages.innerHTML = "";

        // Add your custom welcome message
        const botContainer = document.createElement("div");
        botContainer.classList.add("message-container");

        const botAvatar = createBotAvatar();
        botContainer.appendChild(botAvatar);

        const botMessage = document.createElement("div");
        botMessage.classList.add("message", "bot");
        botMessage.innerHTML = `<p>🎨 Welcome to ATIGAI – Your smart platform to turn ideas into stunning visuals with precision and limitless creativity! 🤖✨</p>`;

        botContainer.appendChild(botMessage);
        messages.appendChild(botContainer);
    };

    clearRequest.onerror = (event) => {
        console.error("Error clearing chat history:", event.target.error);
    };
}
// Ad Popup
function setupAdPopup() {
    if (!sessionStorage.getItem('adShown')) {
        setTimeout(showAd, 1000);
        sessionStorage.setItem('adShown', 'true');
    }

    const closeButton = document.querySelector('.close-ad');
    if (closeButton) {
        closeButton.addEventListener('click', function() {
            if (!this.disabled) {
                closeAd();
            }
        });
    }

    const overlay = document.getElementById('adOverlay');
    if (overlay) {
        overlay.addEventListener('click', function() {
            const closeButton = document.querySelector('.close-ad');
            if (closeButton && !closeButton.disabled) {
                closeAd();
            }
        });
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const closeButton = document.querySelector('.close-ad');
            if (closeButton && !closeButton.disabled) {
                closeAd();
            }
        }
    });
}

function showAd() {
    const adPopup = document.getElementById('adPopup');
    const adOverlay = document.getElementById('adOverlay');
    const adLink = document.getElementById('adLink');

    if (adPopup && adOverlay && adLink) {
        const randomAd = getRandomAd();
        createMediaElement(randomAd);
        adLink.href = randomAd.link;
        adPopup.style.display = 'block';
        adOverlay.style.display = 'block';
        startCountdown();
    }
}

function closeAd() {
    const adPopup = document.getElementById('adPopup');
    const adOverlay = document.getElementById('adOverlay');
    const mediaContainer = document.getElementById('mediaContainer');
    
    if (adPopup && adOverlay) {
        const video = mediaContainer.querySelector('video');
        if (video) {
            video.pause();
            video.src = '';
        }
        
        adPopup.style.display = 'none';
        adOverlay.style.display = 'none';
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
    }
}

const ads = [

    {
        type: 'image',
        source: 'https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/AD635382910276392019.jpg',
        link: 'https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FATIGAI%20-%20Ad%20Placement%20Proposal.html?alt=media&token=a7b5dd24-6d26-4558-94d4-7f0f66b18bca'
    },
    {
      
        type: 'image',
        source: 'https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/AD_1745249592310_23600.png',
        link: 'https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FATIGAI%20-%20Ad%20Placement%20Proposal.html?alt=media&token=a7b5dd24-6d26-4558-94d4-7f0f66b18bca'
    },
    {
        type: 'image',
        source: 'https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/AD_926368292O_73638.jpg',
        link: 'https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FATIGAI%20-%20Ad%20Placement%20Proposal.html?alt=media&token=a7b5dd24-6d26-4558-94d4-7f0f66b18bca'
    },
    {
        type: 'image',
        source: 'https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/file_00000000385c61fa8d54dff06b554c17.jpg',
        link: 'https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FATIGAI%20-%20Ad%20Placement%20Proposal.html?alt=media&token=a7b5dd24-6d26-4558-94d4-7f0f66b18bca'
    },
    {
        type: 'image',
        source: 'https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/ATIGAI_1745303866098_662701.jpg',
        link: 'https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FATIGAI%20-%20Ad%20Placement%20Proposal.html?alt=media&token=a7b5dd24-6d26-4558-94d4-7f0f66b18bca'
    },
    {
        type: 'image',
        source: 'https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/AD_1745303478701_321013.png',
        link: 'https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FATIGAI%20-%20Ad%20Placement%20Proposal.html?alt=media&token=a7b5dd24-6d26-4558-94d4-7f0f66b18bca'
    },
    {
        type: 'image',
        source: 'https://raw.githubusercontent.com/aymantaha3345/atigai.com/refs/heads/main/AD_1745303081586_308221.png',
        link: 'https://firebasestorage.googleapis.com/v0/b/atigai-generated.firebasestorage.app/o/Files%20App%2FATIGAI%20-%20Ad%20Placement%20Proposal.html?alt=media&token=a7b5dd24-6d26-4558-94d4-7f0f66b18bca'
    },
];

const COUNTDOWN_TIME = 15;
let countdownInterval;

function getRandomAd() {
    const randomIndex = Math.floor(Math.random() * ads.length);
    return ads[randomIndex];
}

function createMediaElement(ad) {
    const container = document.getElementById('mediaContainer');
    container.innerHTML = '';

    if (ad.type === 'video') {
        const video = document.createElement('video');
        video.src = ad.source;
        video.controls = true;
        video.autoplay = true;
        video.muted = true;
        video.loop = true;
        if (ad.thumbnail) {
            video.poster = ad.thumbnail;
        }
        container.appendChild(video);
    } else {
        const img = document.createElement('img');
        img.src = ad.source;
        img.alt = 'Advertisement';
        container.appendChild(img);
    }
}

function startCountdown() {
    const closeButton = document.querySelector('.close-ad');
    let timeLeft = COUNTDOWN_TIME;
    
    closeButton.disabled = true;
    closeButton.textContent = timeLeft;

    countdownInterval = setInterval(() => {
        timeLeft--;
        closeButton.textContent = timeLeft;

        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            closeButton.disabled = false;
            closeButton.textContent = '×';
        }
    }, 1000);
}

async function showProfile() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      showAuthPopup();
      return;
    }

    try {
      const { data: profile } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('user_id', user.id)
        .single();

      document.getElementById('profileEmail').value = user.email;
      document.getElementById('profileName').value = profile?.name || user.user_metadata?.name || '';
      document.getElementById('profilePhone').value = profile?.phone || user.user_metadata?.phone || '';
      document.getElementById('profileCountry').value = profile?.country || user.user_metadata?.country || '';
      document.getElementById('currentCredits').textContent = credits;
      document.getElementById('totalCreditsUsed').textContent = profile?.credits_used || '0';

      document.getElementById('profilePopup').style.display = 'block';
      document.getElementById('authOverlay').style.display = 'block';
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }


async function updateProfile() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const name = document.getElementById('profileName').value;
    const phone = document.getElementById('profilePhone').value;
    const country = document.getElementById('profileCountry').value;

    try {
      const { error } = await supabase.auth.updateUser({
        data: { name, phone, country }
      });
      if (error) throw error;

      const { error: profileError } = await supabase.from('user_profiles').upsert({
        user_id: user.id,
        name,
        phone,
        country
      });
      if (profileError) throw profileError;

      document.getElementById('profile-status').textContent = "Profile updated successfully";
    } catch (error) {
      document.getElementById('profile-status').textContent = error.message;
    }
  }

window.closeProfile = closeProfile;

function switchToRegister() {
  document.querySelector('button[onclick="signIn()"]').style.display = 'none';
  document.querySelector('button[onclick="signUp()"]').style.display = 'block';
}
function switchToLogin() {
  document.querySelector('button[onclick="signUp()"]').style.display = 'none';
  document.querySelector('button[onclick="signIn()"]').style.display = 'block';
}


async function logout() {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
      localStorage.removeItem('totalCreditsUsed');
      closeProfile();
      showAuthPopup();
    } catch (error) {
      console.error('Error logging out:', error);
    }
  }

function updateCreditsStats() {
  let totalUsed = parseInt(localStorage.getItem('totalCreditsUsed') || '0');
  totalUsed += 1;
  localStorage.setItem('totalCreditsUsed', totalUsed.toString());

  console.log("credits used updated to:", totalUsed);
  updateCreditsDisplay();
}

 


function initializeCountrySelect() {
    const select = document.getElementById('profileCountry');
    if (!select) return;

    countryList
      .sort((a, b) => a.name.localeCompare(b.name))
      .forEach(country => {
        const option = document.createElement('option');
        option.value = country.code;
        option.textContent = country.name;
        select.appendChild(option);
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    initializeCountrySelect();
  });

  function showAuthPopup() {
    document.getElementById('authPopup').style.display = 'block';
    document.getElementById('authOverlay').style.display = 'block';
  }

  function closeAuthPopup() {
    document.getElementById('authPopup').style.display = 'none';
    document.getElementById('authOverlay').style.display = 'none';
  }

  function closeProfile() {
    document.getElementById('profilePopup').style.display = 'none';
    document.getElementById('authOverlay').style.display = 'none';
  }

  async function checkUser() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) showAuthPopup();
    else await loadUserData();
  }

  async function loadUserData() {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      const { data, error } = await supabase.from('user_profiles').select('*').eq('user_id', user.id).single();
      if (!error && data) {
        localStorage.setItem('totalCreditsUsed', data.credits_used || '0');
        updateCreditsDisplay();
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initializeCountrySelect();
    checkUser();
    document.getElementById('forgotPasswordLink')?.addEventListener('click', (e) => {
      e.preventDefault();
      forgotPassword();
    });
  });

  window.signUp = signUp;
  window.signIn = signIn;
  window.forgotPassword = forgotPassword;
  window.changePassword = changePassword;
  window.updateProfile = updateProfile;
  window.showProfile = showProfile;
  window.logout = logout;
  window.closeProfile = closeProfile;
  window.closeAuthPopup = closeAuthPopup;
 
  window.addEventListener('load', () => {
  initializeCredits();
  updateCreditsDisplay();
});

  async function loadUserProfile() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;

   const { data, error } = await supabase 
    .from('user_profiles') 
    .select('full_name, country, credits_used') 
    .eq('user_id', user.id) 
    .single(); 
 
  if (error) { 
    console.error('Error loading profile:', error); 
    return; 
  } 
 
  document.getElementById('fullNameInput').value = data.full_name || ''; 
  document.getElementById('countrySelect').value = data.country || ''; 
 
  const credits = 10; // القيمة المسموحة يوميًا أو حسب نظامك 
  const used = data.credits_used || 0; 
  const remaining = Math.max(0, credits - used); 
 
  // تخزين محلي واستخدام لاحقًا 
  localStorage.setItem('totalCreditsUsed', used.toString()); 
  document.getElementById('credits-count').textContent = remaining; 
  document.getElementById('totalCreditsUsed').textContent = used; 
  document.getElementById('creditsBanner').textContent = `Credits: ${remaining}`;
}

function manageMonthlyCredits() {
  const storedCredits = localStorage.getItem('credits');
  const lastReset = localStorage.getItem('lastReset');
  const now = new Date();

  let shouldReset = false;
  if (lastReset) {
    const last = new Date(lastReset);
    // تحقق مما إذا كان الشهر أو السنة قد تغيرا
    shouldReset = now.getFullYear() > last.getFullYear() || now.getMonth() > last.getMonth();
  } else {
    shouldReset = true;
  }

  if (shouldReset) {
    credits = 10;
    localStorage.setItem('credits', credits);
    localStorage.setItem('lastReset', now.toISOString());
  } else {
    credits = parseInt(storedCredits || '10');
  }

  updateCreditsDisplay();
}
function updateCreditsDisplay() {  
  // قراءة الكريديت من localStorage
  const credits = parseInt(localStorage.getItem('credits')) || 10;  
  
  // قراءة الكريديت المستخدم من localStorage
  const used = parseInt(localStorage.getItem('totalCreditsUsed')) || 0;  
  
  // حساب الكريديت المتبقي
  const remaining = Math.max(0, credits - used);  

  // تحديث العرض بناءً على الكريديت المتبقي
  const currentCredits = document.getElementById('currentCredits');  
  if (currentCredits) currentCredits.textContent = remaining;  

  const banner = document.getElementById('credits-count');  
  if (banner) banner.textContent = remaining; 
}

const countryList = [
  { name: "Afghanistan", code: "AF" },
  { name: "Albania", code: "AL" },
  { name: "Algeria", code: "DZ" },
  { name: "Andorra", code: "AD" },
  { name: "Angola", code: "AO" },
  { name: "Antigua and Barbuda", code: "AG" },
  { name: "Argentina", code: "AR" },
  { name: "Armenia", code: "AM" },
  { name: "Australia", code: "AU" },
  { name: "Austria", code: "AT" },
  { name: "Azerbaijan", code: "AZ" },
  { name: "Bahamas", code: "BS" },
  { name: "Bahrain", code: "BH" },
  { name: "Bangladesh", code: "BD" },
  { name: "Barbados", code: "BB" },
  { name: "Belarus", code: "BY" },
  { name: "Belgium", code: "BE" },
  { name: "Belize", code: "BZ" },
  { name: "Benin", code: "BJ" },
  { name: "Bhutan", code: "BT" },
  { name: "Bolivia", code: "BO" },
  { name: "Bosnia and Herzegovina", code: "BA" },
  { name: "Botswana", code: "BW" },
  { name: "Brazil", code: "BR" },
  { name: "Brunei", code: "BN" },
  { name: "Bulgaria", code: "BG" },
  { name: "Burkina Faso", code: "BF" },
  { name: "Burundi", code: "BI" },
  { name: "Cabo Verde", code: "CV" },
  { name: "Cambodia", code: "KH" },
  { name: "Cameroon", code: "CM" },
  { name: "Canada", code: "CA" },
  { name: "Central African Republic", code: "CF" },
  { name: "Chad", code: "TD" },
  { name: "Chile", code: "CL" },
  { name: "China", code: "CN" },
  { name: "Colombia", code: "CO" },
  { name: "Comoros", code: "KM" },
  { name: "Congo (Congo-Brazzaville)", code: "CG" },
  { name: "Costa Rica", code: "CR" },
  { name: "Croatia", code: "HR" },
  { name: "Cuba", code: "CU" },
  { name: "Cyprus", code: "CY" },
  { name: "Czech Republic", code: "CZ" },
  { name: "Denmark", code: "DK" },
  { name: "Djibouti", code: "DJ" },
  { name: "Dominica", code: "DM" },
  { name: "Dominican Republic", code: "DO" },
  { name: "Ecuador", code: "EC" },
  { name: "Egypt", code: "EG" },
  { name: "El Salvador", code: "SV" },
  { name: "Equatorial Guinea", code: "GQ" },
  { name: "Eritrea", code: "ER" },
  { name: "Estonia", code: "EE" },
  { name: "Eswatini", code: "SZ" },
  { name: "Ethiopia", code: "ET" },
  { name: "Fiji", code: "FJ" },
  { name: "Finland", code: "FI" },
  { name: "France", code: "FR" },
  { name: "Gabon", code: "GA" },
  { name: "Gambia", code: "GM" },
  { name: "Georgia", code: "GE" },
  { name: "Germany", code: "DE" },
  { name: "Ghana", code: "GH" },
  { name: "Greece", code: "GR" },
  { name: "Grenada", code: "GD" },
  { name: "Guatemala", code: "GT" },
  { name: "Guinea", code: "GN" },
  { name: "Guinea-Bissau", code: "GW" },
  { name: "Guyana", code: "GY" },
  { name: "Haiti", code: "HT" },
  { name: "Honduras", code: "HN" },
  { name: "Hungary", code: "HU" },
  { name: "Iceland", code: "IS" },
  { name: "India", code: "IN" },
  { name: "Indonesia", code: "ID" },
  { name: "Iran", code: "IR" },
  { name: "Iraq", code: "IQ" },
  { name: "Ireland", code: "IE" },
  { name: "Israel", code: "IL" },
  { name: "Italy", code: "IT" },
  { name: "Jamaica", code: "JM" },
  { name: "Japan", code: "JP" },
  { name: "Jordan", code: "JO" },
  { name: "Kazakhstan", code: "KZ" },
  { name: "Kenya", code: "KE" },
  { name: "Kiribati", code: "KI" },
  { name: "Kuwait", code: "KW" },
  { name: "Kyrgyzstan", code: "KG" },
  { name: "Laos", code: "LA" },
  { name: "Latvia", code: "LV" },
  { name: "Lebanon", code: "LB" },
  { name: "Lesotho", code: "LS" },
  { name: "Liberia", code: "LR" },
  { name: "Libya", code: "LY" },
  { name: "Liechtenstein", code: "LI" },
  { name: "Lithuania", code: "LT" },
  { name: "Luxembourg", code: "LU" },
  { name: "Madagascar", code: "MG" },
  { name: "Malawi", code: "MW" },
  { name: "Malaysia", code: "MY" },
  { name: "Maldives", code: "MV" },
  { name: "Mali", code: "ML" },
  { name: "Malta", code: "MT" },
  { name: "Marshall Islands", code: "MH" },
  { name: "Mauritania", code: "MR" },
  { name: "Mauritius", code: "MU" },
  { name: "Mexico", code: "MX" },
  { name: "Micronesia", code: "FM" },
  { name: "Moldova", code: "MD" },
  { name: "Monaco", code: "MC" },
  { name: "Mongolia", code: "MN" },
  { name: "Montenegro", code: "ME" },
  { name: "Morocco", code: "MA" },
  { name: "Mozambique", code: "MZ" },
  { name: "Myanmar", code: "MM" },
  { name: "Namibia", code: "NA" },
  { name: "Nauru", code: "NR" },
  { name: "Nepal", code: "NP" },
  { name: "Netherlands", code: "NL" },
  { name: "New Zealand", code: "NZ" },
  { name: "Nicaragua", code: "NI" },
  { name: "Niger", code: "NE" },
  { name: "Nigeria", code: "NG" },
  { name: "North Korea", code: "KP" },
  { name: "North Macedonia", code: "MK" },
  { name: "Norway", code: "NO" },
  { name: "Oman", code: "OM" },
  { name: "Pakistan", code: "PK" },
  { name: "Palau", code: "PW" },
  { name: "Palestine", code: "PS" },
  { name: "Panama", code: "PA" },
  { name: "Papua New Guinea", code: "PG" },
  { name: "Paraguay", code: "PY" },
  { name: "Peru", code: "PE" },
  { name: "Philippines", code: "PH" },
  { name: "Poland", code: "PL" },
  { name: "Portugal", code: "PT" },
  { name: "Qatar", code: "QA" },
  { name: "Romania", code: "RO" },
  { name: "Russia", code: "RU" },
  { name: "Rwanda", code: "RW" },
  { name: "Saint Kitts and Nevis", code: "KN" },
  { name: "Saint Lucia", code: "LC" },
  { name: "Saint Vincent and the Grenadines", code: "VC" },
  { name: "Samoa", code: "WS" },
  { name: "San Marino", code: "SM" },
  { name: "Saudi Arabia", code: "SA" },
  { name: "Senegal", code: "SN" },
  { name: "Serbia", code: "RS" },
  { name: "Seychelles", code: "SC" },
  { name: "Sierra Leone", code: "SL" },
  { name: "Singapore", code: "SG" },
  { name: "Slovakia", code: "SK" },
  { name: "Slovenia", code: "SI" },
  { name: "Solomon Islands", code: "SB" },
  { name: "Somalia", code: "SO" },
  { name: "South Africa", code: "ZA" },
  { name: "South Korea", code: "KR" },
  { name: "South Sudan", code: "SS" },
  { name: "Spain", code: "ES" },
  { name: "Sri Lanka", code: "LK" },
  { name: "Sudan", code: "SD" },
  { name: "Suriname", code: "SR" },
  { name: "Sweden", code: "SE" },
  { name: "Switzerland", code: "CH" },
  { name: "Syria", code: "SY" },
  { name: "Taiwan", code: "TW" },
  { name: "Tajikistan", code: "TJ" },
  { name: "Tanzania", code: "TZ" },
  { name: "Thailand", code: "TH" },
  { name: "Timor-Leste", code: "TL" },
  { name: "Togo", code: "TG" },
  { name: "Tonga", code: "TO" },
  { name: "Trinidad and Tobago", code: "TT" },
  { name: "Tunisia", code: "TN" },
  { name: "Turkey", code: "TR" },
  { name: "Turkmenistan", code: "TM" },
  { name: "Tuvalu", code: "TV" },
  { name: "Uganda", code: "UG" },
  { name: "Ukraine", code: "UA" },
  { name: "United Arab Emirates", code: "AE" },
  { name: "United Kingdom", code: "GB" },
  { name: "United States of America", code: "US" },
  { name: "Uruguay", code: "UY" },
  { name: "Uzbekistan", code: "UZ" },
  { name: "Vanuatu", code: "VU" },
  { name: "Vatican City", code: "VA" },
  { name: "Venezuela", code: "VE" },
  { name: "Vietnam", code: "VN" },
  { name: "Yemen", code: "YE" },
  { name: "Zambia", code: "ZM" },
  { name: "Zimbabwe", code: "ZW" }
];

</script>
</head>
    </html>